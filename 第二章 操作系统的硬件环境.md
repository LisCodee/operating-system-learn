# 第二章 操作系统的硬件环境
- 操作系统运行的硬件环境组成
- 中央处理器
- 存储系统
- 中断系统
- I/O系统
- 时钟以及时钟序列

//- Linux中断处理

> 操作系统的运行环境主要包括系统的硬件环境和由其他的系统软件形成的软件环境。
> - 中央处理器专门为操作系统设计了一系列基本机制，包括具有特权界别的处理器状态，以及能在不同特权级别运行的各种特权指令。
> - 存储系统提供了分层的存储体系结构和存储能力，为操作系统实现用户程序的虚拟地址空间隔离和保护提供了基础。
> - 终端机制是操作系统得以正常工作的最重要的手段。
> - I/O机制是操作系统管理各种系统设备的基础设施，时钟则是操作系统定时以及操作系统多到程序运转的推动力。

## 2.1 中央处理器（CPU）

### 2.1.1 CPU的构成与基本工作方式
> 一般的处理器由运算器、控制器、一系列的寄存器以及高速缓存构成。运算器实现指令中的算术和逻辑运算，是计算机计算的核心；控制器负责控制程序运行的流程，包括取指令、维护CPU状态等；寄存器是指令在CPU内部作处理过程中暂存数据的存储设备，具有最快的访问速度，高速缓存处于CPU和物理内存之间，一般由控制器中的内存管理单元（MMU）管理，用于使CPU和内存速度的匹配，提高CPU效率。

#### 1 处理器中的寄存器
- 用户可见寄存器
    * 数据寄存器
    * 地址寄存器
    * 条件码寄存器
- 控制和状态寄存器：大部分对于用户不可见，一部分可以在某种特权模式下访问。
    * 程序计数器（PC）：记录了将要取出的指令地址
    * 指令寄存器（IR）：包含了最近取出的指令
    * 程序状态字（PSW）：记录了处理器的运行模式信息等

#### 2指令执行的基本过程
> 处理器先从存储器中每次读取一条指令，然后执行这条指令，一个这样的单条指令处理过程称为一个指令周期。

指令周期.png

指令类型：
- 访问存储器指令
- I/O指令：访问I/O
- 算术逻辑指令：执行有关数据的算术和逻辑操作
- 控制转义指令：指定一个新的指令执行七点
- 处理器控制指令：用于修改处理器状态，改变处理器工作方式

### 2.1.2 特权指令和费特权指令
- 特权指令：只能由操作系统使用的指令
- 非特权指令：用户程序可以使用
> 依赖于处理器状态的表示，CPU可以知道当前运行的是操作系统还是一般应用软件。

### 2.1.3 处理器的状态
- 管态：操作系统管理程序运行的状态，具有较高的特权级别，又称特权态、系统态、核心态
- 目态：用户程序运行时的状态，具有较低的特权级别，又称用户态
> 当处理器处于管态时全部指令可以执行，可使用所有资源，并具有改变处理器状态的能力，当管理器处于目态时，就只能执行非特权指令。

**目态到管态的唯一途径是通过中断，管态到目态可以通过设置PSW来达到目的。**

### 2.1.4 程序状态字 PSW
#### 组成
- CPU的工作状态码：指明管态还是目态
- 条件码：反应指令执行后的结果特征
- 中断屏蔽码：指出是否允许终端

#### Pentium系列程序状态字
Pentium系列PSW.png
- CF：进位标志位
- ZF:结果为0标志位
- SF：符号标志位
- OF：溢出标志位
- TF：陷阱标志位
- IF：终端屏蔽标志位
- VIF：虚拟中断标志位
- VIP：虚拟中断待决标志位
- IOPL：IO特权级别

## 2.2 存储系统

### 2.2.1 存储器的类型
- 随机访问存储器（RAM）
- 只读存储器（ROM）

### 2.2.2 存储器的层次结构
- 采用层次化的存储体系结构，沿着层次下降时，每Bit价格下降，容量增大，速度变慢，处理器访问频率也下降。
- 从整个系统来看，计算机系统的存储装置是由寄存器、高速缓存、内存储器、磁盘存储器、磁带机和光盘存储器等装置构成。
- **能达到提高存储系统效能这个目的的关键点就在于程序的存储访问局部性原理。**

### 2.2.3 存储分块
> 为了简化对存储器的分配和管理，在不少计算机系统中吧存储器分成块，在为用户分配内存空间时，以块为最小单位，这样的块有时被称为一个物理页（page），而块的大小随机器而异。

### 2.2.4 存储保护
#### 界地址寄存器（界限寄存器）
>  机制简单，易于实现。在CPU中设置一对界限寄存器存放该用户作业在内存中的上限和下限地址，当CPU访问内存时，硬件自动将被访问的内存地址与界限寄存器的内容进行比较，以判断是否越界，如果越界则产生程序性中断——越界中断。

#### 存储键
> 每个存储块都有一个与其相关的由二进位组成的存储保护键附加在该存储块上，当一个用户作业进入内存时，操作系统会给他一个惟一的、与其他作业不同的存储键号，并将分配给该作业的个存储块的存储键号放入程序状态字PSW的存储键（“钥匙”）域中。每当CPU访问内存时，都将该内存块的存储键与PSW中的钥匙进行比较，如果匹配则允许访问，否则拒绝并报警。

## 2.3 缓冲技术
> 缓冲区是硬件设备之间进行数据传输是专门用来暂存这些数据的一个存储区域。**目的是为了解决部件之间速度不匹配的问题。**

- 处理器与内存
- 处理器与外设
- 设备与设备

> 目前许多计算机系统广泛使用一种多Cache技术，在运行过程中，CPU首先到一级Cache中寻找，如果没有找到，接着到二级Cache中找，如果Cache中没有，才去系统内存中找。

## 2.4 中断技术

### 2.4.1 中断的概念
> 所谓中断是指计算机在执行期间，系统内过系统外发生异步事件，使得CPU暂时中止当前正在执行的程序，而转去执行相应的事件处理程序，待处理完毕后又返回原来被中断处继续执行或调度新的进程执行的过程。

- 中断断点：发生中断时正在执行的程序的暂停点
- 中断响应：处理器暂停当前程序转而去处理中断的过程
- 中断返回：中断处理结束后恢复原来程序的执行
- 中断字：一个计算机系统提供的中断源的有序集合
- 中断屏蔽：系统通过软件设置，有选择的封锁部分中断源而允许其他中断源的中断信号被送入CPU

#### 中断系统的作用
- 充分发挥处理器使用效率
- 提高系统的实时能力

#### 中断的分类
- 程序中断
- 软件中断（Trap指令或中断指令Int）
- 时钟中断
- I/O中断
- 硬件失效中断

**根据中断是否可屏蔽：**
- 可屏蔽中断（I/O中断）
- 不可屏蔽中断（机器内部故障、掉电中断）

**IBM370中断划分：**
- 机器故障中断
- 输入输出中断
- 外部中断
- 程序中断
- 访管中断

**根据中断源划分：**
- 硬中断
    * 外中断：来自处理器和内存以外的中断
    * 内中断：处理器和内存内部产生的中断
- 软中断

### 2.4.2 中断系统
> 中断系统是现代计算机系统的核心机制之一，由硬件中断装置和软件中断处理程序组成。

- 中断装置：负责捕获中断源发出的中断请求，并以一定的方式相应中断源，然后将处理器的控制权交给特定的中断处理程序。
    * 提供识别中断源的方法
    * 提供查询终端状态的方法，通常使用一个中断寄存器存储有关中断的状态信息，寄存器中的内容一般称为状态字
    * 提供中断现场保护能力，包括保护程序状态字、程序计数器和必要的系统寄存器
    * 提供中断处理程序寻址能力
    * 具有预定义的系统控制栈和中断处理程序入口地址映射表（中断向量表）。
- 中断处理程序：负责分辨中断类型并根据请求作出相应操作。

### 2.4.3 中断逻辑与中断寄存器
> 为了区分和不丢失每个中断信号，通常对每个中断源分别用一个固定的触发器来寄存中断信号，其值为1时，表示该触发器有中断信号。这些触发器的全体称为**中断寄存器**，每个触发器称为一个**中断位**。**所以中断寄存器是由若干个中断位组成的**。

- 中断扫描机构：处理器的控制部件中增设的一个能检测中断的机构，通常在每条指令执行周期内的最后时刻扫描中断寄存器，询问是否有中断信号到来。
- 中断码：中断硬件将中断触发器内容按规定的编码送入程序状态字PSW的相应位

### 2.4.4 中断优先级和中断屏蔽
> 在多级中断系统中，很可能同时有多个中断请求，这是CPU接收中断优先级最高的中断，忽略中断优先级较低的中断。

对于同一中断级中的多个设备接口的中断请求：
- 固定的优先数，为每个设备接口安排一个不同的，固定的优先顺序，一种方法是以该设备在总线中离CPU的距离确定，距离越近，优先数越高
- 轮转法：用一个表，依次轮转响应，较为公平合理

### 2.4.5 中断响应
- 响应时机：通常在一条指令执行完毕后，更确切的说实在指令周期的最后时刻接受中断请求，或是在此时刻扫描中断寄存器
- 响应条件：CPU没有被禁止，即PSW中的中断允许标志位是开中断的且中断没有被屏蔽
- 中断源的识别：判断是哪个中断源发出的中断。

### 2.4.6 中断处理
#### 简单的中断处理
- 设备给处理器发送中断信号
- 处理器处理完当前指令后响应中断
- 处理器处理完当前指令后检测到中断，判断出中断源并向发送中断的设备发送确认中断信号，确认信号使得该设备将中断信号恢复到一般状态
- 处理器开始为软件处理中断做准备：保存断点，保护现场，处理器状态切换到管态。
- 处理器根据中断源查询中断向量表，找到中断处理程序入口地址，将PC设成该地址，开始一个新的指令周期，结果是控制转移到中断处理程序。
- 中断处理程序开始工作
- 中断处理结束时，CPU检测到中断返回指令，恢复现场和断点
- PSW和PC被恢复成中断前的值，CPU开始一个新的指令周期，中断处理结束。
简单中断处理过程.png

#### 多中断处理
> 1. 当处理一个中断时禁止中断，此时对任何新发生的中断置之不理。在这期间发生的中断将被挂起，当处理器再次允许中断时，新的中断号会被处理器检测并做处理。
> 2. 中断按照优先级划分，允许优先级高的中断打断优先级低的中断

## 2.5 I/O技术

### 2.5.1 程序控制I/O技术
> 由处理器提供相关的I/O指令来实现，缺点是CPU必须关注I/O处理单元的状态，严重降低系统性能
### 2.5.2 中断驱动I/O技术
> 当I/O处理单元准备好与设备交互的时候通过物理信号通知CPU

### 2.5.3 DMA技术（直接存储器访问Direct Memory Access）
> DMA通过系统总线中的一个独立控制单元————DMA控制器，自动的控制成块数据在内存和I/O单元之间的传送。但是处理器和DMA不是完全并行的，会有总线竞争的情况发生。对于大数据的I/O传送来说，DMA技术很有价值。
### 2.5.4 通道
> 独立于中央处理器，专门负责数据I/O传输工作的处理单元，对外设实现统一管理，代替CPU对I/O操作进行控制，使CPU和外设可以并行工作，所以又称为I/O处理机。一般用于对I/O处理能力要求严格的系统中。

## 2.6 时钟
时钟的必要性：
- 在多道程序运行的环境中，可以为系统发现一个陷入死循环的作业，从而防止机时浪费
- 在分时系统中，用间隔时钟来实现作业按时间片轮转
- 在实时系统中，按照要求的时间间隔输出正确的时间信号给一个实时的控制设备
- 定时唤醒那些要求延迟执行的各个外部事件
- 记录用户使用各种设备的时间和记录某外部事件发生的时间间隔
- 记录用户和系统所需要的绝对时间
- 绝对时钟：记录当时的时间
- 间隔时钟：通过时钟寄存器实现